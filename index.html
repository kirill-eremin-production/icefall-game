<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ú–∏–Ω–∏-–°—Ç—Ä–∞—Ç–µ–≥–∏—è</title>
  <style>
    :root {
      --bg: #0f1226;
      --panel: #1b2040;
      --accent: #5cc8ff;
      --accent-2: #7bff90;
      --danger: #ff6b6b;
      --text: #e8ecf1;
      --muted: #aab3c5;
      --gold: #ffd166;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 80% -200px, #1a1f3f 0%, #0d1022 40%, var(--bg) 100%);
      color: var(--text);
      min-height: 100vh;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 76px 20px 20px;
      /* Reserve space for fixed side panels */
      padding-left: 260px;
      padding-right: 320px;
    }
    header.topbar {
      position: fixed;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      width: min(1100px, calc(100% - 20px));
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin: 0;
      background: linear-gradient(180deg, #252b53, #1a1f41);
      border: 1px solid #2b3266;
      border-radius: 12px;
      padding: 6px 10px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.25), inset 0 0 20px rgba(92,200,255,0.06);
      z-index: 1001;
    }
    h1 {
      font-size: 22px;
      font-weight: 700;
      margin: 0;
      letter-spacing: 0.3px;
    }
    .timer {
      background: linear-gradient(180deg, #252b53, #1a1f41);
      border: 1px solid #2b3266;
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 700;
      color: var(--text);
      box-shadow: inset 0 0 20px rgba(92,200,255,0.06);
    }
    .timer.small { padding: 6px 10px; font-size: 14px; }

    .hud {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
    }
    .hud-res {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    .chip {
      background: #121633;
      border: 1px solid #2b3266;
      color: var(--text);
      padding: 4px 8px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 12px;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn.sm { padding: 6px 8px; font-size: 12px; border-radius: 8px; }
    .rateTop { color: #8bb9ff; font-weight: 700; margin-left: 4px; }
    .chip .lbl { font-weight: 700; font-size: 11px; color: var(--muted); letter-spacing: 0.3px; margin-right: 4px; }

    /* Speed segmented control */
    .seg {
      display: inline-flex;
      align-items: center;
      gap: 2px;
      background: #121633;
      border: 1px solid #2b3266;
      border-radius: 10px;
      padding: 2px;
    }
    .seg-btn {
      background: transparent;
      border: 0;
      color: var(--text);
      padding: 4px 10px;
      border-radius: 8px;
      font-weight: 800;
      font-size: 12px;
      cursor: pointer;
      line-height: 1;
    }
    .seg-btn.active {
      background: linear-gradient(180deg, #2a70ff, #224dcc);
      border: 1px solid #2e5fff;
    }

    .grid {
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 12px;
    }
    @media (max-width: 900px) {
      .grid { grid-template-columns: 1fr; }
    }
    .panel {
      background: linear-gradient(180deg, #1b2146, #131837);
      border: 1px solid #2a3165;
      border-radius: 14px;
      padding: 10px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.25), inset 0 0 40px rgba(124,148,255,0.04);
    }
    .panel h2 {
      margin: 0 0 12px 0;
      font-size: 16px;
      font-weight: 700;
      color: var(--accent);
      letter-spacing: 0.4px;
    }
    .resources {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    .res {
      background: #121633;
      border: 1px solid #2b3266;
      border-radius: 10px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .res .name {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.7px;
    }
    .res .value {
      font-size: 18px;
      font-weight: 800;
    }
    .res .rate {
      font-size: 12px;
      color: #8bb9ff;
    }
    .build-list {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 700px) {
      .build-list { grid-template-columns: 1fr; }
    }
    .build {
      background: #121633;
      border: 1px solid #2b3266;
      border-radius: 10px;
      padding: 8px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
    }
    .build .title {
      font-weight: 700;
      margin-bottom: 6px;
    }
    .build .subtitle {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .cost {
      display: flex;
      flex-wrap: wrap;
      gap: 6px 10px;
      font-size: 12px;
      color: var(--muted);
    }
    .cost span { display: inline-flex; gap: 6px; align-items: center; }
    .btn {
      background: linear-gradient(180deg, #2a70ff, #224dcc);
      border: 1px solid #2e5fff;
      color: white;
      padding: 10px 12px;
      border-radius: 10px;
      font-weight: 800;
      cursor: pointer;
      transition: transform 0.05s ease, filter 0.15s ease, opacity 0.15s ease;
      white-space: nowrap;
    }
    .btn:hover { filter: brightness(1.05); }
    .btn:active { transform: translateY(1px); }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .missions {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .mission {
      background: #121633;
      border: 1px solid #2b3266;
      border-radius: 10px;
      padding: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .mission .text { font-size: 14px; }
    .mission .status {
      font-size: 12px;
      font-weight: 800;
      color: var(--muted);
    }
    .mission.done {
      border-color: #3ba86b;
      box-shadow: inset 0 0 20px rgba(60,200,120,0.12);
    }
    .mission.done .status {
      color: var(--accent-2);
    }
    .log {
      height: 120px;
      overflow: auto;
      background: #0f1330;
      border: 1px solid #2b3266;
      border-radius: 10px;
      padding: 10px;
      font-size: 12px;
    }
    .log p { margin: 0 0 4px 0; color: #b2c3ff; }
    .footer {
      margin-top: 14px;
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: flex-end;
    }
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(5, 8, 25, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 2000;
      backdrop-filter: blur(2px);
    }
    .modal {
      background: linear-gradient(180deg, #1b2146, #151a3c);
      border: 1px solid #2a3165;
      border-radius: 16px;
      padding: 20px;
      max-width: 520px;
      width: 100%;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,0.35), inset 0 0 60px rgba(124,148,255,0.06);
    }
    .modal h3 {
      margin: 0 0 10px 0;
      font-size: 20px;
    }
    .muted { color: var(--muted); }
    .danger { color: var(--danger); }
    .gold { color: var(--gold); }

    /* Start settings form */
    .form { display: flex; flex-direction: column; gap: 10px; margin-top: 8px; }
    .form .row { display: grid; grid-template-columns: 1.2fr 1fr; align-items: center; gap: 10px; }
    @media (max-width: 520px) { .form .row { grid-template-columns: 1fr; } }
    .form label { font-size: 13px; color: var(--muted); text-align: right; }
    @media (max-width: 520px) { .form label { text-align: left; } }
    .form select {
      background: #121633;
      color: var(--text);
      border: 1px solid #2b3266;
      border-radius: 8px;
      padding: 8px 10px;
      font-weight: 700;
    }
    .form .hint { margin-top: 6px; font-size: 12px; color: var(--muted); }
    /* End settings form */

  /* Resource emoji labels */
    .resources .res:nth-child(1) .name::before { content: "üå≤ "; }
    .resources .res:nth-child(2) .name::before { content: "ü™® "; }
    .resources .res:nth-child(3) .name::before { content: "üçñ "; }
    .resources .res:nth-child(4) .name::before { content: "ü™ô "; }

  /* Map (visual buildings) */
    .map {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      grid-template-rows: repeat(6, 1fr);
      gap: 4px;
      background: #0f1330;
      border: 1px solid #2b3266;
      border-radius: 12px;
      padding: 8px;
      /* Make the map a square and center it */
      aspect-ratio: 1 / 1;
      width: min(80vmin, 720px);
      margin: 0 auto;
      box-shadow: inset 0 0 40px rgba(124,148,255,0.06);
      overflow: hidden;
    }
    /* –í—ã–±–æ—Ä –∫–ª–µ—Ç–∫–∏ –¥–ª—è —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ */
    .map.selecting {
      box-shadow: inset 0 0 0 2px #2e5fff, inset 0 0 40px rgba(124,148,255,0.12);
    }
    .tile.selectable {
      cursor: crosshair;
      outline: 2px dashed #2e5fff;
      outline-offset: -2px;
      background: linear-gradient(180deg, #141a45, #10163a);
    }
    .tile.selectable:hover {
      background: linear-gradient(180deg, #18205a, #121a44);
      filter: brightness(1.05);
    }
    .tile.occ {
      opacity: 0.95;
    }
    .tile {
      background: linear-gradient(180deg, #121633, #0e1230);
      border: 1px solid #1f2550;
      border-radius: 6px;
      position: relative;
    }
    .bld {
      display: grid;
      place-items: center;
      font-size: 18px;
      user-select: none;
      border-radius: 8px;
      transition: transform 0.12s ease, filter 0.2s ease;
      animation: pop-in 160ms ease-out;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
      /* allow –∫–ª–∏–∫–∏ –ø–æ –ø–ª–∏—Ç–∫–∞–º –¥–∞–∂–µ –µ—Å–ª–∏ –∏–∫–æ–Ω–∫–∞ –∑–¥–∞–Ω–∏—è –ø–æ–≤–µ—Ä—Ö */
      pointer-events: none;
    }
    .bld:hover { transform: translateY(-1px) scale(1.02); filter: brightness(1.05); }
    .bld[data-type="townHall"] { font-size: 22px; }
    @keyframes pop-in {
      from { transform: scale(0.85); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
    }
    .legend span b { font-size: 14px; margin-right: 6px; }

    /* Fixed side panels */
    .left-fixed {
      position: fixed;
      left: 10px;
      top: 76px;
      width: 220px;
      z-index: 1000;
    }
    .right-fixed {
      position: fixed;
      right: 10px;
      top: 76px;
      width: 280px;
      max-height: calc(100vh - 96px);
      overflow: auto;
      z-index: 1000;
    }
    .left-fixed .panel,
    .right-fixed .panel { margin: 0; }

    /* Build list as a narrow column */
    .left-fixed .build-list {
      grid-template-columns: 1fr;
    }

    /* Compact build cards */
    .left-fixed .build { padding: 8px; }
    .left-fixed .build .subtitle { font-size: 11px; }
    .left-fixed .build .cost { font-size: 11px; }

    /* Collapsible log */
    .details-log { margin-top: 8px; }
    .details-log summary {
      cursor: pointer;
      color: var(--muted);
      user-select: none;
      font-weight: 700;
    }
    .details-log .log { margin-top: 8px; }

    /* Responsive adjustments */
    @media (max-width: 900px) {
      .left-fixed, .right-fixed {
        position: static;
        width: auto;
        max-height: none;
      }
      .container {
        padding-left: 20px;
        padding-right: 20px;
      }
      .map { width: min(92vmin, 640px); }
    }

  </style>
</head>
<body>
  <div class="container">
    <header class="topbar">
      <div class="hud">
        <div class="hud-res">
          <span class="chip"><span class="lbl">–î–µ—Ä–µ–≤–æ</span> üå≤ <b id="woodValTop">0</b> <span class="rateTop" id="woodRateTop">+0/—Å</span></span>
          <span class="chip"><span class="lbl">–ö–∞–º–µ–Ω—å</span> ü™® <b id="stoneValTop">0</b> <span class="rateTop" id="stoneRateTop">+0/—Å</span></span>
          <span class="chip"><span class="lbl">–ï–¥–∞</span> üçñ <b id="foodValTop">0</b> <span class="rateTop" id="foodRateTop">+0/—Å</span></span>
          <span class="chip"><span class="lbl">–ó–æ–ª–æ—Ç–æ</span> ü™ô <b id="goldValTop">0</b> <span class="rateTop" id="goldRateTop">+0/—Å</span></span>
          <span class="chip"><span class="lbl">–ñ–∏—Ç–µ–ª–∏</span> üë• <b id="popValTop">0</b> <span class="rateTop" id="popRateTop">+0/—Å</span></span>
        </div>
        <div style="display:flex; align-items:center; gap:8px;">
          <div class="timer small">‚è± <span id="timeText">04:00</span></div>
          <div class="seg" aria-label="–°–∫–æ—Ä–æ—Å—Ç—å –≤—Ä–µ–º–µ–Ω–∏">
            <button class="seg-btn active" id="btn-speed-1">x1</button>
            <button class="seg-btn" id="btn-speed-2">x2</button>
            <button class="seg-btn" id="btn-speed-3">x3</button>
          </div>
          <button class="btn sm" id="btn-pause">–ü–∞—É–∑–∞</button>
          <button class="btn sm" id="btn-resume" disabled>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        </div>
      </div>
    </header>

    <!-- Left fixed build menu -->
    <aside class="left-fixed">
      <section class="panel">
        <h2>–°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ</h2>
        <div class="build-list">
          <div class="build">
            <div>
              <div class="title">–î–æ–º <span class="muted">(x<span id="cnt-house">0</span>)</span></div>
              <div class="subtitle">+3 üë•</div>
              <div class="cost" id="cost-house"></div>
            </div>
            <button class="btn" id="btn-house">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å</button>
          </div>
          <div class="build">
            <div>
              <div class="title">–õ–µ—Å–æ–ø–∏–ª–∫–∞ <span class="muted">(x<span id="cnt-lumberMill">0</span>)</span></div>
              <div class="subtitle">+1 üå≤/—Å</div>
              <div class="cost" id="cost-lumberMill"></div>
            </div>
            <button class="btn" id="btn-lumberMill">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å</button>
          </div>
          <div class="build">
            <div>
              <div class="title">–ö–∞–º–µ–Ω–æ–ª–æ–º–Ω—è <span class="muted">(x<span id="cnt-quarry">0</span>)</span></div>
              <div class="subtitle">+1 ü™®/—Å</div>
              <div class="cost" id="cost-quarry"></div>
            </div>
            <button class="btn" id="btn-quarry">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å</button>
          </div>
          <div class="build">
            <div>
              <div class="title">–§–µ—Ä–º–∞ <span class="muted">(x<span id="cnt-farm">0</span>)</span></div>
              <div class="subtitle">+1 üçñ/—Å</div>
              <div class="cost" id="cost-farm"></div>
            </div>
            <button class="btn" id="btn-farm">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å</button>
          </div>
          <div class="build">
            <div>
              <div class="title">–ó–æ–ª–æ—Ç–æ–π —Ä—É–¥–Ω–∏–∫ <span class="muted">(x<span id="cnt-goldMine">0</span>)</span></div>
              <div class="subtitle">+0.5 ü™ô/—Å</div>
              <div class="cost" id="cost-goldMine"></div>
            </div>
            <button class="btn" id="btn-goldMine">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å</button>
          </div>
          <div class="build">
            <div>
              <div class="title">–†–∞—Ç—É—à–∞ <span class="muted">(x<span id="cnt-townHall">0</span>)</span></div>
              <div class="subtitle gold">–ü–æ—Å—Ç—Ä–æ–π—Ç–µ, —á—Ç–æ–±—ã –≤—ã–∏–≥—Ä–∞—Ç—å</div>
              <div class="cost" id="cost-townHall"></div>
            </div>
            <button class="btn" id="btn-townHall">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å</button>
          </div>
        </div>
      </section>
    </aside>

    <!-- Right fixed missions and collapsible log -->
    <aside class="right-fixed">
      <section class="panel">
        <h2>–ó–∞–¥–∞–Ω–∏—è</h2>
        <div class="missions" id="missions"></div>
        <details class="details-log">
          <summary>–ñ—É—Ä–Ω–∞–ª</summary>
          <div class="log" id="log"></div>
        </details>
      </section>
    </aside>

    <section class="panel">
      <h2>–ü–æ—Å–µ–ª–µ–Ω–∏–µ</h2>
      <div class="map" id="map"></div>
      <div class="legend">
        <span><b>üèõÔ∏è</b> –†–∞—Ç—É—à–∞</span>
        <span><b>ü™ì</b> –õ–µ—Å–æ–ø–∏–ª–∫–∞</span>
        <span><b>‚õèÔ∏è</b> –ö–∞–º–µ–Ω–æ–ª–æ–º–Ω—è</span>
        <span><b>üåæ</b> –§–µ—Ä–º–∞</span>
        <span><b>üè†</b> –î–æ–º</span>
        <span><b>ü™ô</b> –ó–æ–ª–æ—Ç–æ–π —Ä—É–¥–Ω–∏–∫</span>
      </div>
    </section>

    <!-- –ü–∞–Ω–µ–ª–∏ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ –∏ –∑–∞–¥–∞–Ω–∏–π –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –≤ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –±–æ–∫–æ–≤—ã–µ –ø–∞–Ω–µ–ª–∏ -->
  </div>

  <div class="overlay" id="startOverlay">
    <div class="modal">
      <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏</h3>
      <div class="form">
        <div class="row">
          <label for="sel-cost">–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–¥–∞–Ω–∏–π</label>
          <select id="sel-cost">
            <option value="cheap">–¥–µ—à–µ–≤—ã–µ (–ø—Ä–æ—â–µ)</option>
            <option value="medium" selected>—Å—Ä–µ–¥–Ω–∏–µ</option>
            <option value="expensive">–¥–æ—Ä–æ–≥–∏–µ (—Å–ª–æ–∂–Ω–µ–µ)</option>
          </select>
        </div>
        <div class="row">
          <label for="sel-time">–í—Ä–µ–º—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏–π</label>
          <select id="sel-time">
            <option value="short">–º–∞–ª–æ –≤—Ä–µ–º–µ–Ω–∏ (—Å–ª–æ–∂–Ω–µ–µ)</option>
            <option value="medium" selected>—Å—Ä–µ–¥–Ω–∏–π –∑–∞–ø–∞—Å –≤—Ä–µ–º–µ–Ω–∏</option>
            <option value="long">–º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ (–ø—Ä–æ—â–µ)</option>
          </select>
        </div>
        <div class="row">
          <label for="sel-missions">–°–ª–æ–∂–Ω–æ—Å—Ç—å –∑–∞–¥–∞–Ω–∏–π</label>
          <select id="sel-missions">
            <option value="easy">–ª–µ–≥–∫–∏–µ –∑–∞–¥–∞–Ω–∏—è</option>
            <option value="medium" selected>—Å—Ä–µ–¥–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</option>
            <option value="hard">—Å–ª–æ–∂–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è</option>
          </select>
        </div>
        <p id="startInfo" class="hint">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: 04:00, –±–∞–∑–æ–≤—ã–µ —Ü–µ–Ω—ã –∏ 3 –∑–∞–¥–∞–Ω–∏—è.</p>
      </div>
      <div style="display:flex; gap:10px; justify-content:center; margin-top:14px;">
        <button class="btn" id="btn-start">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="winOverlay" style="display:none;">
    <div class="modal">
      <h3 class="gold">–ü–æ–±–µ–¥–∞!</h3>
      <p>–í—ã –≤—ã–ø–æ–ª–Ω–∏–ª–∏ –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è –∏ –ø–æ—Å—Ç—Ä–æ–∏–ª–∏ –†–∞—Ç—É—à—É –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏.</p>
      <div style="display:flex; gap:10px; justify-content:center; margin-top:14px;">
        <button class="btn" id="btn-restart-win">–°—ã–≥—Ä–∞—Ç—å –µ—â—ë —Ä–∞–∑</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="loseOverlay" style="display:none;">
    <div class="modal">
      <h3 class="danger">–ü–æ—Ä–∞–∂–µ–Ω–∏–µ</h3>
      <p>–í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ ‚Äî —É –≤–∞—Å –ø–æ–ª—É—á–∏—Ç—Å—è!</p>
      <div style="display:flex; gap:10px; justify-content:center; margin-top:14px;">
        <button class="btn" id="btn-restart-lose">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <script>
    (() => {
      const format = (n) => {
        return (Math.abs(n) % 1 < 0.001) ? Math.round(n).toString() : n.toFixed(1);
      };

      const state = {
        started: false,
        paused: false,
        won: false,
        timeLeft: 240,
        multiplier: 1.25,
        resources: { wood: 50, stone: 50, food: 30, gold: 0, pop: 3 },
        rates: { wood: 0, stone: 0, food: 0, gold: 0, pop: 0 },
        counts: { house: 0, lumberMill: 0, quarry: 0, farm: 0, goldMine: 0, townHall: 0 },
        loops: { tick: null, ui: null, timer: null },
        map: { w: 12, h: 6, occupied: [] },
        built: [],
        timeSpeed: 1,
        settings: { cost: 'medium', time: 'medium', missions: 'medium' },
      };

      const BUILDINGS = {
        house: {
          key: 'house',
          name: '–î–æ–º',
          resource: 'pop',
          baseRate: 0,
          fixedPopGain: 3,
          baseCost: { wood: 5, stone: 5, food: 5, gold: 0, pop: 0 },
        },
        lumberMill: {
          key: 'lumberMill',
          name: '–õ–µ—Å–æ–ø–∏–ª–∫–∞',
          resource: 'wood',
          baseRate: 1,
          baseCost: { wood: 0, stone: 10, food: 5, gold: 0, pop: 1 },
        },
        quarry: {
          key: 'quarry',
          name: '–ö–∞–º–µ–Ω–æ–ª–æ–º–Ω—è',
          resource: 'stone',
          baseRate: 1,
          baseCost: { wood: 10, stone: 0, food: 5, gold: 0, pop: 1 },
        },
        farm: {
          key: 'farm',
          name: '–§–µ—Ä–º–∞',
          resource: 'food',
          baseRate: 1,
          baseCost: { wood: 10, stone: 10, food: 0, gold: 0, pop: 1 },
        },
        goldMine: {
          key: 'goldMine',
          name: '–ó–æ–ª–æ—Ç–æ–π —Ä—É–¥–Ω–∏–∫',
          resource: 'gold',
          baseRate: 0.5,
          baseCost: { wood: 30, stone: 30, food: 20, gold: 0, pop: 2 },
        },
        townHall: {
          key: 'townHall',
          name: '–†–∞—Ç—É—à–∞',
          resource: null,
          baseRate: 0,
          baseCost: { wood: 150, stone: 150, food: 100, gold: 75, pop: 5 },
          single: true,
        },
      };

      // Visual map/icons for buildings
      const ICONS = {
        house: 'üè†',
        lumberMill: 'ü™ì',
        quarry: '‚õèÔ∏è',
        farm: 'üåæ',
        goldMine: 'ü™ô',
        townHall: 'üèõÔ∏è',
      };

      // Difficulty mappings
      const COST_SCALE = { cheap: 0.8, medium: 1.0, expensive: 1.5 };
      const TIME_PRESETS = { short: 240, medium: 360, long: 480 };

      // Helpers
      function formatTimeSecToMMSS(sec) {
        const mm = String(Math.floor(sec / 60)).padStart(2, '0');
        const ss = String(sec % 60).padStart(2, '0');
        return mm + ':' + ss;
      }

      function generateMissions(level) {
        if (level === 'easy') {
          return [
            { id: 1, text: '–ü–æ—Å—Ç—Ä–æ–π—Ç–µ 1 –õ–µ—Å–æ–ø–∏–ª–∫—É, 1 –ö–∞–º–µ–Ω–æ–ª–æ–º–Ω—é –∏ 1 –§–µ—Ä–º—É', check: () => state.counts.lumberMill >= 1 && state.counts.quarry >= 1 && state.counts.farm >= 1 },
            { id: 2, text: '–ù–∞–∫–æ–ø–∏—Ç–µ 150 –¥–µ—Ä–µ–≤–∞, 150 –∫–∞–º–Ω—è –∏ 80 –µ–¥—ã', check: () => state.resources.wood >= 150 && state.resources.stone >= 150 && state.resources.food >= 80 },
            { id: 3, text: '–ü–æ—Å—Ç—Ä–æ–π—Ç–µ –†–∞—Ç—É—à—É', check: () => state.counts.townHall >= 1 },
          ];
        } else if (level === 'hard') {
          return [
            { id: 1, text: '–ü–æ—Å—Ç—Ä–æ–π—Ç–µ 6 –ª–µ—Å–æ–ø–∏–ª–æ–∫, 6 –∫–∞–º–µ–Ω–æ–ª–æ–º–µ–Ω –∏ 6 —Ñ–µ—Ä–º', check: () => state.counts.lumberMill >= 6 && state.counts.quarry >= 6 && state.counts.farm >= 6 },
            { id: 2, text: '–ù–∞–∫–æ–ø–∏—Ç–µ 250 –¥–µ—Ä–µ–≤–∞, 250 –∫–∞–º–Ω—è –∏ 120 –µ–¥—ã', check: () => state.resources.wood >= 250 && state.resources.stone >= 250 && state.resources.food >= 120 },
            { id: 3, text: '–ü–æ—Å—Ç—Ä–æ–π—Ç–µ –ó–æ–ª–æ—Ç–æ–π —Ä—É–¥–Ω–∏–∫', check: () => state.counts.goldMine >= 1 },
            { id: 4, text: '–ù–∞–∫–æ–ø–∏—Ç–µ 50 –∑–æ–ª–æ—Ç–∞', check: () => state.resources.gold >= 50 },
            { id: 5, text: '–ü–æ—Å—Ç—Ä–æ–π—Ç–µ –†–∞—Ç—É—à—É', check: () => state.counts.townHall >= 1 },
          ];
        }
        // medium (default)
        return [
          { id: 1, text: '–ü–æ—Å—Ç—Ä–æ–π—Ç–µ 1 –õ–µ—Å–æ–ø–∏–ª–∫—É, 1 –ö–∞–º–µ–Ω–æ–ª–æ–º–Ω—é –∏ 1 –§–µ—Ä–º—É', check: () => state.counts.lumberMill >= 1 && state.counts.quarry >= 1 && state.counts.farm >= 1 },
          { id: 2, text: '–ù–∞–∫–æ–ø–∏—Ç–µ 200 –¥–µ—Ä–µ–≤–∞, 200 –∫–∞–º–Ω—è –∏ 100 –µ–¥—ã', check: () => state.resources.wood >= 200 && state.resources.stone >= 200 && state.resources.food >= 100 },
          { id: 3, text: '–ü–æ—Å—Ç—Ä–æ–π—Ç–µ –†–∞—Ç—É—à—É', check: () => state.counts.townHall >= 1 },
        ];
      }

      function applySettings() {
        // time
        state.timeLeft = TIME_PRESETS[state.settings.time] || 240;
        // missions
        MISSIONS = generateMissions(state.settings.missions);
        renderMissions();
        // Costs will be recalculated dynamically via currentCost -> COST_SCALE
      }

      function updateStartInfo() {
        if (!el.startInfo) return;
        const t = TIME_PRESETS[el.sel.time.value] || 240;
        const m = el.sel.missions.value;
        const tasksCount = generateMissions(m).length;
        let costLabel = el.sel.cost.value === 'cheap' ? '–¥–µ—à—ë–≤—ã–µ' : el.sel.cost.value === 'expensive' ? '–¥–æ—Ä–æ–≥–∏–µ' : '—Å—Ä–µ–¥–Ω–∏–µ';
        const msg = `–í—Ä–µ–º—è: ${formatTimeSecToMMSS(t)}, —Ü–µ–Ω—ã: ${costLabel}, –∑–∞–¥–∞–Ω–∏–π: ${tasksCount}.`;
        el.startInfo.textContent = msg;
      }

      function resetMapState() {
        state.map.occupied = Array.from({ length: state.map.h }, () => Array(state.map.w).fill(null));
        state.built = [];
      }

      function initMapTiles() {
        if (!el.map) return;
        // reset tiles and occupancy
        el.map.innerHTML = '';
        resetMapState();
        // init tiles storage
        tiles.byPos = Array.from({ length: state.map.h }, () => Array(state.map.w).fill(null));
        // render base tiles
        for (let y = 0; y < state.map.h; y++) {
          for (let x = 0; x < state.map.w; x++) {
            const t = document.createElement('div');
            t.className = 'tile';
            t.dataset.x = String(x);
            t.dataset.y = String(y);
            t.style.gridColumn = String(x + 1);
            t.style.gridRow = String(y + 1);
            t.addEventListener('click', onTileClick);
            el.map.appendChild(t);
            tiles.byPos[y][x] = t;
          }
        }
      }

      function findFreeCell() {
        for (let y = 0; y < state.map.h; y++) {
          for (let x = 0; x < state.map.w; x++) {
            if (!state.map.occupied[y][x]) return { x, y };
          }
        }
        return null;
      }

      function placeBuilding(buildKey) {
        if (!el.map) return;
        const pos = findFreeCell();
        if (!pos) {
          log('–ù–∞ –∫–∞—Ä—Ç–µ –Ω–µ—Ç —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ ‚Äî –Ω–æ–≤–æ–µ –∑–¥–∞–Ω–∏–µ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–æ.');
          return;
        }
        placeBuildingAt(buildKey, pos.x, pos.y);
      }

      function placeBuildingAt(buildKey, x, y) {
        if (!el.map) return;
        state.map.occupied[y][x] = buildKey;
        const icon = ICONS[buildKey] || 'üèóÔ∏è';
        const def = BUILDINGS[buildKey];
        const b = document.createElement('div');
        b.className = 'bld';
        b.dataset.type = buildKey;
        b.style.gridColumn = String(x + 1);
        b.style.gridRow = String(y + 1);
        b.title = def.name;
        b.textContent = icon;
        el.map.appendChild(b);
        state.built.push({ key: buildKey, x, y });
        // –ø–æ–º–µ—Ç–∏—Ç—å –ø–ª–∏—Ç–∫—É –∑–∞–Ω—è—Ç–æ–π
        const tile = tiles.byPos?.[y]?.[x];
        if (tile) tile.classList.add('occ');
      }

      let MISSIONS = generateMissions('medium');
      // —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Å—ã–ª–æ–∫ –Ω–∞ –ø–ª–∏—Ç–∫–∏ –∫–∞—Ä—Ç—ã
      const tiles = {
        byPos: [], // [y][x] -> HTMLElement
      };
      // —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –∫–ª–µ—Ç–∫–∏ –¥–ª—è —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞
      state.placement = { active: false, buildKey: null };

      // DOM
      const el = {
        timeText: document.getElementById('timeText'),
        startOverlay: document.getElementById('startOverlay'),
        winOverlay: document.getElementById('winOverlay'),
        loseOverlay: document.getElementById('loseOverlay'),
        log: document.getElementById('log'),
        missions: document.getElementById('missions'),
        map: document.getElementById('map'),
        btnStart: document.getElementById('btn-start'),
        btnPause: document.getElementById('btn-pause'),
        btnResume: document.getElementById('btn-resume'),
        btnRestartWin: document.getElementById('btn-restart-win'),
        btnRestartLose: document.getElementById('btn-restart-lose'),
        startInfo: document.getElementById('startInfo'),
        sel: {
          cost: document.getElementById('sel-cost'),
          time: document.getElementById('sel-time'),
          missions: document.getElementById('sel-missions'),
        },
        resVals: {
          wood: document.getElementById('woodVal'),
          stone: document.getElementById('stoneVal'),
          food: document.getElementById('foodVal'),
          gold: document.getElementById('goldVal'),
        },
        resValsTop: {
          wood: document.getElementById('woodValTop'),
          stone: document.getElementById('stoneValTop'),
          food: document.getElementById('foodValTop'),
          gold: document.getElementById('goldValTop'),
          pop: document.getElementById('popValTop'),
        },
        rateVals: {
          wood: document.getElementById('woodRate'),
          stone: document.getElementById('stoneRate'),
          food: document.getElementById('foodRate'),
          gold: document.getElementById('goldRate'),
        },
        rateValsTop: {
          wood: document.getElementById('woodRateTop'),
          stone: document.getElementById('stoneRateTop'),
          food: document.getElementById('foodRateTop'),
          gold: document.getElementById('goldRateTop'),
          pop: document.getElementById('popRateTop'),
        },
        cnt: {
          house: document.getElementById('cnt-house'),
          lumberMill: document.getElementById('cnt-lumberMill'),
          quarry: document.getElementById('cnt-quarry'),
          farm: document.getElementById('cnt-farm'),
          goldMine: document.getElementById('cnt-goldMine'),
          townHall: document.getElementById('cnt-townHall'),
        },
        cost: {
          house: document.getElementById('cost-house'),
          lumberMill: document.getElementById('cost-lumberMill'),
          quarry: document.getElementById('cost-quarry'),
          farm: document.getElementById('cost-farm'),
          goldMine: document.getElementById('cost-goldMine'),
          townHall: document.getElementById('cost-townHall'),
        },
        btn: {
          house: document.getElementById('btn-house'),
          lumberMill: document.getElementById('btn-lumberMill'),
          quarry: document.getElementById('btn-quarry'),
          farm: document.getElementById('btn-farm'),
          goldMine: document.getElementById('btn-goldMine'),
          townHall: document.getElementById('btn-townHall'),
        },
        speed: {
          x1: document.getElementById('btn-speed-1'),
          x2: document.getElementById('btn-speed-2'),
          x3: document.getElementById('btn-speed-3'),
        },
      };

      // Utils
      function log(msg) {
        const p = document.createElement('p');
        p.textContent = msg;
        el.log.prepend(p);
      }

      function currentCost(buildKey) {
        const def = BUILDINGS[buildKey];
        const c = state.counts[buildKey];
        const factor = def.single ? 1 : Math.pow(state.multiplier, c);
        const base = def.baseCost;
        const s = COST_SCALE[state.settings.cost] || 1;
        const bv = (v) => Math.ceil(((v || 0)) * factor * s);
        return {
          wood: bv(base.wood),
          stone: bv(base.stone),
          food: bv(base.food),
          gold: bv(base.gold),
          pop: bv(base.pop),
        };
      }

      function canAfford(cost) {
        return (
          state.resources.wood >= cost.wood &&
          state.resources.stone >= cost.stone &&
          state.resources.food >= cost.food &&
          state.resources.gold >= cost.gold &&
          state.resources.pop >= (cost.pop || 0)
        );
      }

      function spend(cost) {
        state.resources.wood -= cost.wood;
        state.resources.stone -= cost.stone;
        state.resources.food -= cost.food;
        state.resources.gold -= cost.gold;
        state.resources.pop -= (cost.pop || 0);
      }

      function addRates(res, value) {
        if (!res) return;
        state.rates[res] += value;
      }

      // —Ä–µ–∂–∏–º –≤—ã–±–æ—Ä–∞ –∫–ª–µ—Ç–∫–∏ –¥–ª—è —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞
      function enterPlacementMode(buildKey) {
        const def = BUILDINGS[buildKey];
        if (def.single && state.counts[buildKey] >= 1) {
          log(def.name + ': —É–∂–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–æ.');
          return;
        }
        const free = findFreeCell();
        if (!free) {
          log('–ù–∞ –∫–∞—Ä—Ç–µ –Ω–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö –∫–ª–µ—Ç–æ–∫.');
          return;
        }
        // –°–æ—Ö—Ä–∞–Ω–∏–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞—É–∑—ã –∏ –ø–æ—Å—Ç–∞–≤–∏–º –∏–≥—Ä—É –Ω–∞ –ø–∞—É–∑—É
        state.placement.prevPaused = !!state.paused;
        state.placement.active = true;
        state.placement.buildKey = buildKey;
        state.paused = true;
        refreshUI();

        if (el.map) el.map.classList.add('selecting');
        for (let y = 0; y < state.map.h; y++) {
          for (let x = 0; x < state.map.w; x++) {
            if (!state.map.occupied[y][x]) {
              tiles.byPos[y][x]?.classList.add('selectable');
            } else {
              tiles.byPos[y][x]?.classList.remove('selectable');
            }
          }
        }
        log('–ò–≥—Ä–∞ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –Ω–∞ –ø–∞—É–∑—É. –í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–µ—Ç–∫—É –¥–ª—è —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞: ' + def.name + '. –ù–∞–∂–º–∏—Ç–µ Esc, —á—Ç–æ–±—ã –æ—Ç–º–µ–Ω–∏—Ç—å.');
      }

      function leavePlacementMode() {
        state.placement.active = false;
        state.placement.buildKey = null;
        if (el.map) el.map.classList.remove('selecting');
        for (let y = 0; y < state.map.h; y++) {
          for (let x = 0; x < state.map.w; x++) {
            tiles.byPos[y][x]?.classList.remove('selectable');
          }
        }
        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º –ø–∞—É–∑—É ‚Äî –µ—Å–ª–∏ –¥–æ –≤—Ö–æ–¥–∞ –≤ —Ä–µ–∂–∏–º –≤—ã–±–æ—Ä–∞ –∏–≥—Ä–∞ –±—ã–ª–∞ –∑–∞–ø—É—â–µ–Ω–∞, –≤–æ–∑–æ–±–Ω–æ–≤–∏–º
        const prev = state.placement.prevPaused;
        if (typeof prev !== 'undefined') {
          // prevPaused === true –æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ —Ä–∞–Ω–µ–µ –∏–≥—Ä–∞ –±—ã–ª–∞ –Ω–∞ –ø–∞—É–∑–µ, –ø–æ—ç—Ç–æ–º—É –æ—Å—Ç–∞–≤–∏–º –ø–∞—É–∑—É
          state.paused = !!prev;
          delete state.placement.prevPaused;
        } else {
          // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–Ω–∏–º–µ–º –ø–∞—É–∑—É
          state.paused = false;
        }
        refreshUI();
      }

      function onTileClick(e) {
        // –†–∞–∑—Ä–µ—à–∞–µ–º –∫–ª–∏–∫ –ø–æ –ø–ª–∏—Ç–∫–µ –¥–∞–∂–µ –∫–æ–≥–¥–∞ –∏–≥—Ä–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –Ω–∞ –ø–∞—É–∑—É –≤ —Ä–µ–∂–∏–º–µ –≤—ã–±–æ—Ä–∞ –∫–ª–µ—Ç–∫–∏.
        // –ò–≥—Ä–æ–∫ –º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å –∫–ª–µ—Ç–∫—É –¥–ª—è —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞, –¥–∞–∂–µ –µ—Å–ª–∏ state.paused === true,
        // –Ω–æ –¥—Ä—É–≥–∏–µ –∫–ª–∏–∫–∏ –≤–Ω–µ —Ä–µ–∂–∏–º–∞ –≤—ã–±–æ—Ä–∞ –æ—Å—Ç–∞—é—Ç—Å—è –±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã.
        if (!state.started) return;
        if (!state.placement.active) return;
        const t = e.currentTarget;
        const x = Number(t.dataset.x);
        const y = Number(t.dataset.y);
        if (state.map.occupied[y][x]) {
          log('–≠—Ç–∞ –∫–ª–µ—Ç–∫–∞ —É–∂–µ –∑–∞–Ω—è—Ç–∞.');
          return;
        }
        const buildKey = state.placement.buildKey;
        const def = BUILDINGS[buildKey];
        const cost = currentCost(buildKey);
        if (!canAfford(cost)) {
          log('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–ª—è: ' + def.name);
          return;
        }
        // —Å–ø–∏—Å—ã–≤–∞–µ–º –∏ —Å—Ç—Ä–æ–∏–º
        spend(cost);
        state.counts[buildKey] += 1;
        addRates(def.resource, def.baseRate);
        if (def.fixedPopGain) {
          state.resources.pop = (state.resources.pop || 0) + def.fixedPopGain;
        }
        placeBuildingAt(def.key, x, y);
  
        const parts = [];
        if (cost.wood) parts.push('üå≤ ' + cost.wood);
        if (cost.stone) parts.push('ü™® ' + cost.stone);
        if (cost.food) parts.push('üçñ ' + cost.food);
        if (cost.gold) parts.push('ü™ô ' + cost.gold);
        if (cost.pop) parts.push('üë• ' + cost.pop);
        log('–ü–æ—Å—Ç—Ä–æ–µ–Ω–æ: ' + def.name + (parts.length ? ' (—Å—Ç–æ–∏–º–æ—Å—Ç—å: ' + parts.join(', ') + ')' : ''));
        if (def.fixedPopGain) log('–ù–∞—Å–µ–ª–µ–Ω–∏–µ —É–≤–µ–ª–∏—á–µ–Ω–æ –Ω–∞ +' + def.fixedPopGain);
  
        // –°–æ—Ö—Ä–∞–Ω–∏–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞—É–∑—ã –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º –ø–æ—Å–ª–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
        const prev = state.placement.prevPaused;
        leavePlacementMode();
        if (typeof prev !== 'undefined' && !prev) {
          // –µ—Å–ª–∏ –¥–æ –≤—Ö–æ–¥–∞ –≤ —Ä–µ–∂–∏–º –≤—ã–±–æ—Ä–∞ –∏–≥—Ä–∞ –±—ã–ª–∞ –ù–ï –Ω–∞ –ø–∞—É–∑–µ ‚Äî –≤–æ–∑–æ–±–Ω–æ–≤–∏–º —Ü–∏–∫–ª—ã
          if (!state.won && !state.loops.tick) startLoops();
          state.paused = false;
        }
  
        checkMissions();
        renderCosts();
        refreshUI();
        checkWin();
      }

      function build(buildKey) {
        // —Ç–µ–ø–µ—Ä—å –ø–µ—Ä–≤–∞—è —Å—Ç–∞–¥–∏—è: –≤—ã–±–æ—Ä –∫–ª–µ—Ç–∫–∏
        if (!state.started) return;
        enterPlacementMode(buildKey);
      }

      function checkMissions() {
        let changed = false;
        for (const m of MISSIONS) {
          const nowDone = m.check();
          if (nowDone !== !!m.done) {
            m.done = nowDone;
            changed = true;
            if (nowDone) log('–ó–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: ' + m.text);
          }
        }
        if (changed) renderMissions();
        // –ù–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–¥–∞—á–∞ –∑–∞–∫—Ä—ã–ª–∞—Å—å –æ—Ç –ø–∞—Å—Å–∏–≤–Ω–æ–≥–æ –ø—Ä–∏—Ä–æ—Å—Ç–∞ ‚Äî –ø—Ä–æ–≤–µ—Ä–∏–º –ø–æ–±–µ–¥—É
        checkWin();
      }

      function setSpeed(mult) {
        state.timeSpeed = mult;
        updateSpeedUI();
      }
      function updateSpeedUI() {
        if (!el.speed) return;
        const s = state.timeSpeed;
        if (el.speed.x1) el.speed.x1.classList.toggle('active', s === 1);
        if (el.speed.x2) el.speed.x2.classList.toggle('active', s === 2);
        if (el.speed.x3) el.speed.x3.classList.toggle('active', s === 3);
      }

      function checkWin() {
        const allDone = MISSIONS.every(m => m.check());
        if (allDone && !state.won) {
          state.won = true;
          stopLoops();
          el.winOverlay.style.display = 'flex';
          log('–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏! –†–∞—Ç—É—à–∞ –≤–æ–∑–≤–µ–¥–µ–Ω–∞, –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è –∑–∞–∫—Ä—ã—Ç—ã.');
        }
      }

      function tick() {
        if (state.paused) return;
        const sp = state.timeSpeed || 1;
        // add resources accelerated by speed
        for (const k of ['wood','stone','food','gold','pop']) {
          state.resources[k] += state.rates[k] * sp;
        }
        checkMissions();
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –ø–æ–±–µ–¥—ã –ø—Ä–∏ –ø–∞—Å—Å–∏–≤–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
        checkWin();
      }

      function renderCosts() {
        for (const key of Object.keys(BUILDINGS)) {
          const cost = currentCost(key);
          const c = [];
          if (cost.wood) c.push('üå≤ ' + cost.wood);
          if (cost.stone) c.push('ü™® ' + cost.stone);
          if (cost.food) c.push('üçñ ' + cost.food);
          if (cost.gold) c.push('ü™ô ' + cost.gold);
          if (cost.pop) c.push('üë• ' + cost.pop);
          el.cost[key].textContent = c.length ? ('–°—Ç–æ–∏–º–æ—Å—Ç—å: ' + c.join(' | ')) : '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ';
        }
      }

      function refreshUI() {
        // resources (bottom panel, –µ—Å–ª–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç)
        if (el.resVals.wood) el.resVals.wood.textContent = format(state.resources.wood);
        if (el.resVals.stone) el.resVals.stone.textContent = format(state.resources.stone);
        if (el.resVals.food) el.resVals.food.textContent = format(state.resources.food);
        if (el.resVals.gold) el.resVals.gold.textContent = format(state.resources.gold);

        // —Ä–µ—Å—É—Ä—Å—ã –≤ –≤–µ—Ä—Ö–Ω–µ–º HUD
        if (el.resValsTop) {
          if (el.resValsTop.wood) el.resValsTop.wood.textContent = format(state.resources.wood);
          if (el.resValsTop.stone) el.resValsTop.stone.textContent = format(state.resources.stone);
          if (el.resValsTop.food) el.resValsTop.food.textContent = format(state.resources.food);
          if (el.resValsTop.gold) el.resValsTop.gold.textContent = format(state.resources.gold);
          if (el.resValsTop.pop) el.resValsTop.pop.textContent = format(state.resources.pop);
        }

        // –¥–æ—Ö–æ–¥—ã —Å–Ω–∏–∑—É (–µ—Å–ª–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç) ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å —É—á—ë—Ç–æ–º —Å–∫–æ—Ä–æ—Å—Ç–∏
        const spd = state.timeSpeed || 1;
        if (el.rateVals.wood) el.rateVals.wood.textContent = '+' + format(state.rates.wood * spd) + '/—Å';
        if (el.rateVals.stone) el.rateVals.stone.textContent = '+' + format(state.rates.stone * spd) + '/—Å';
        if (el.rateVals.food) el.rateVals.food.textContent = '+' + format(state.rates.food * spd) + '/—Å';
        if (el.rateVals.gold) el.rateVals.gold.textContent = '+' + format(state.rates.gold * spd) + '/—Å';

        // –¥–æ—Ö–æ–¥—ã –≤ –≤–µ—Ä—Ö–Ω–µ–º HUD ‚Äî —Ç–∞–∫–∂–µ —Å —É—á—ë—Ç–æ–º —Å–∫–æ—Ä–æ—Å—Ç–∏
        if (el.rateValsTop) {
          if (el.rateValsTop.wood) el.rateValsTop.wood.textContent = '+' + format(state.rates.wood * spd) + '/—Å';
          if (el.rateValsTop.stone) el.rateValsTop.stone.textContent = '+' + format(state.rates.stone * spd) + '/—Å';
          if (el.rateValsTop.food) el.rateValsTop.food.textContent = '+' + format(state.rates.food * spd) + '/—Å';
          if (el.rateValsTop.gold) el.rateValsTop.gold.textContent = '+' + format(state.rates.gold * spd) + '/—Å';
          if (el.rateValsTop.pop) el.rateValsTop.pop.textContent = '+' + format(state.rates.pop * spd) + '/—Å';
        }

        // –æ–±–Ω–æ–≤–∏—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏
        updateSpeedUI();

        // counts
        for (const key of Object.keys(state.counts)) {
          el.cnt[key].textContent = state.counts[key];
        }

        // buttons enabled/disabled
        for (const key of Object.keys(BUILDINGS)) {
          const cost = currentCost(key);
          const def = BUILDINGS[key];
          const can = canAfford(cost) && !(def.single && state.counts[key] >= 1);
          // –†–∞–∑—Ä–µ—à–∞–µ–º –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –¥–∞–∂–µ –∫–æ–≥–¥–∞ –∏–≥—Ä–∞ –Ω–∞ –ø–∞—É–∑–µ,
          // –Ω–æ –∫–Ω–æ–ø–∫–∏ –≤—Å—ë –µ—â—ë –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –µ—Å–ª–∏ –∏–≥—Ä–∞ –Ω–µ –Ω–∞—á–∞—Ç–∞ –∏–ª–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ.
          el.btn[key].disabled = !state.started || !can;
        }

        // timer
        const mm = String(Math.floor(state.timeLeft / 60)).padStart(2,'0');
        const ss = String(state.timeLeft % 60).padStart(2,'0');
        el.timeText.textContent = mm + ':' + ss;
      }

      function renderMissions() {
        el.missions.innerHTML = '';
        for (const m of MISSIONS) {
          const div = document.createElement('div');
          div.className = 'mission' + (m.check() ? ' done' : '');
          const left = document.createElement('div');
          left.className = 'text';
          left.textContent = m.text;
          const right = document.createElement('div');
          right.className = 'status';
          right.textContent = m.check() ? '–ì–æ—Ç–æ–≤–æ' : '–í –ø—Ä–æ—Ü–µ—Å—Å–µ';
          div.appendChild(left);
          div.appendChild(right);
          el.missions.appendChild(div);
        }
      }

      function startTimer() {
        state.loops.timer = setInterval(() => {
          if (state.paused) return;
          if (state.won) return;
          const sp = state.timeSpeed || 1;
          state.timeLeft -= sp;
          if (state.timeLeft <= 0) {
            state.timeLeft = 0;
            stopLoops();
            if (!state.won) {
              el.loseOverlay.style.display = 'flex';
              log('–ü–æ—Ä–∞–∂–µ–Ω–∏–µ: –≤—Ä–µ–º—è –≤—ã—à–ª–æ.');
            }
          }
        }, 1000);
      }

      function startLoops() {
        state.loops.tick = setInterval(tick, 1000);
        state.loops.ui = setInterval(refreshUI, 200);
        startTimer();
      }
      function stopLoops() {
        if (state.loops.tick) clearInterval(state.loops.tick);
        if (state.loops.ui) clearInterval(state.loops.ui);
        if (state.loops.timer) clearInterval(state.loops.timer);
        state.loops.tick = state.loops.ui = state.loops.timer = null;
      }

      function pause() {
        state.paused = true;
        refreshUI();
      }
      function resume() {
        state.paused = false;
        refreshUI();
      }

      function restart() {
        stopLoops();
        // reset state
        state.started = false;
        state.paused = false;
        state.won = false;
        state.resources = { wood: 50, stone: 50, food: 30, gold: 0, pop: 3 };
        state.rates = { wood: 0, stone: 0, food: 0, gold: 0, pop: 0 };
        state.counts = { house: 0, lumberMill: 0, quarry: 0, farm: 0, goldMine: 0, townHall: 0 };
        state.placement = { active: false, buildKey: null };
        // apply current settings to time and missions
        applySettings();
        for (const m of MISSIONS) delete m.done;
        el.winOverlay.style.display = 'none';
        el.loseOverlay.style.display = 'none';
        el.startOverlay.style.display = 'flex';
        el.log.innerHTML = '';
        // reflect selected values in UI
        if (el.sel?.cost) el.sel.cost.value = state.settings.cost;
        if (el.sel?.time) el.sel.time.value = state.settings.time;
        if (el.sel?.missions) el.sel.missions.value = state.settings.missions;
        updateStartInfo();
        // re-init map
        initMapTiles();
        renderCosts();
        refreshUI();
      }

      // Bindings
      el.btnStart.addEventListener('click', () => {
        if (state.started) return;
        // take settings from selects
        if (el.sel && el.sel.cost) state.settings.cost = el.sel.cost.value;
        if (el.sel && el.sel.time) state.settings.time = el.sel.time.value;
        if (el.sel && el.sel.missions) state.settings.missions = el.sel.missions.value;
        applySettings();
        renderCosts();
        state.started = true;
        el.startOverlay.style.display = 'none';
        const tasksCount = MISSIONS.length;
        const timeText = formatTimeSecToMMSS(state.timeLeft);
        const costLabel = state.settings.cost === 'cheap' ? '–¥–µ—à—ë–≤—ã–µ' : state.settings.cost === 'expensive' ? '–¥–æ—Ä–æ–≥–∏–µ' : '—Å—Ä–µ–¥–Ω–∏–µ';
        log(`–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å! –ù–∞—Å—Ç—Ä–æ–π–∫–∏: –≤—Ä–µ–º—è ${timeText}, —Ü–µ–Ω—ã ${costLabel}, –∑–∞–¥–∞–Ω–∏–π ${tasksCount}.`);
        startLoops();
        refreshUI();
      });
      el.btnPause.addEventListener('click', () => {
        if (!state.started || state.paused) return;
        pause();
        el.btnPause.disabled = true;
        el.btnResume.disabled = false;
        log('–ü–∞—É–∑–∞.');
      });
      el.btnResume.addEventListener('click', () => {
        if (!state.started || !state.paused) return;
        resume();
        el.btnPause.disabled = false;
        el.btnResume.disabled = true;
        log('–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ.');
      });

      el.btnRestartWin.addEventListener('click', restart);
      el.btnRestartLose.addEventListener('click', restart);

      for (const key of Object.keys(BUILDINGS)) {
        el.btn[key].addEventListener('click', () => build(key));
      }

      // —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç—å—é
      if (el.speed && el.speed.x1) el.speed.x1.addEventListener('click', () => setSpeed(1));
      if (el.speed && el.speed.x2) el.speed.x2.addEventListener('click', () => setSpeed(2));
      if (el.speed && el.speed.x3) el.speed.x3.addEventListener('click', () => setSpeed(3));
      
      // –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –≤—Ä–µ–º–µ–Ω–∏/–∑–∞–¥–∞—á –Ω–∞ —Å—Ç–∞—Ä—Ç–µ
      if (el.sel && el.sel.cost) el.sel.cost.addEventListener('change', updateStartInfo);
      if (el.sel && el.sel.time) el.sel.time.addEventListener('change', updateStartInfo);
      if (el.sel && el.sel.missions) el.sel.missions.addEventListener('change', updateStartInfo);

      // Esc –¥–ª—è –æ—Ç–º–µ–Ω—ã —Ä–µ–∂–∏–º–∞ –≤—ã–±–æ—Ä–∞ –∫–ª–µ—Ç–∫–∏
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && state.placement?.active) {
          leavePlacementMode();
          log('–í—ã–±–æ—Ä –∫–ª–µ—Ç–∫–∏ –æ—Ç–º–µ–Ω—ë–Ω.');
        }
      });
      
      // Initial paint
      initMapTiles();
      renderMissions();
      renderCosts();
      updateSpeedUI();
      updateStartInfo();
      refreshUI();
    })();
  </script>
</body>
</html>